name: Release

on:
    workflow_dispatch:

jobs:
    build:

        runs-on: ubuntu-latest
        steps:
            -   uses: actions/checkout@v3
            -   name: Use Node.js 17.x
                uses: actions/setup-node@v3
                with:
                    node-version: 17.x
                    registry-url: 'https://registry.npmjs.org'

            -   name: Install dependencies
                run: npm ci
            -   run: npm run test:unit
            -   run: |
                    ./scripts/bump-version.sh
                    npm publish
                env:
                    NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

            -   uses: docker/setup-qemu-action@v1
            -   uses: docker/setup-buildx-action@v1
            -   uses: docker/metadata-action@v3
                with:
                    images: |
                        lightswitch05/node-version-audit
                        ghcr.io/lightswitch05/node-version-audit
                    tags: type=semver,pattern={{major}}
                    flavor: latest=true
            -   uses: docker/login-action@v1
                with:
                    username: lightswitch05
                    password: ${{ secrets.DOCKERHUB_TOKEN }}
            -   uses: docker/login-action@v1
                with:
                    registry: ghcr.io
                    username: lightswitch05
                    password: ${{ secrets.GITHUB_TOKEN }}
            -   name: Build and push
                uses: docker/build-push-action@v2
                with:
                    context: ./
                    platforms: linux/amd64, linux/arm64
                    build-args: |
                        NODE_IMAGE_TAG=17
                    file: ./docker/Dockerfile
                    tags: ${{ steps.meta.outputs.tags }}
                    labels: ${{ steps.meta.outputs.labels }}
